=====================
Общие принципы работы
=====================

Существует множество роутеров и различных стандартов разбора ссылок. Пользователи CMS ратуют за возможность гибкой настройки, разработчики же по техническим причинам полной кастомизации не реализуют.

При разработке изначальной версии роутера рассматривалось лишь удобство шаблонизации. Проще говоря, чтобы из адреса можно было узнать название шаблона, папки и страницы. Но в нем не учитывались язык, административный раздел, многоуровневая структура вложенности папок.

При дальнейшем использовании это доставляло некоторые проблемы. Поэтому, во-первых, было решено строго <структура>структурировать сайт, а во-вторых, сделать новый качественный роутер.

Данная версия роутера более жесткая и зависимая. У нее нет возможности гибкой настройки. С другой стороны, он зависим от заданной структуры сайта и многие вещи обрабатывает автоматически.

Но если вам нужен иной роутер, вы можете задать его сами. Самое главное - соблюсти формат данных, которые роутер возвращает после разбора ссылки.

================
Загрузка роутера
================

Роутер подгружается в шаблонизаторе, практически сразу же после инициализации <шаблон>объекта шаблона и до чтения настроек и прочего. Основное условие работы роутера - наличие <структура>структуры сайта.

Основной объект, с которым работает роутер, называется <переменные>$path. Он инициализируется в самом начале роутера и удаляется после передачи данных в <переменные>объект $template.

Дальнейшая работа ведется с разделом "router" этого объекта: {{ $template -> router -> ... }}

==============
Данные роутера
==============

Роутер разбирает ссылку из адресной строки и возвращает следующие данные:

	"lang" - язык сайта, если конечно, у вас есть необходимость в мультиязычности сайта
	"types" - ассоциативный массив из типов элементов структуры сайта, где ключ - имя элемента структуры (файла или папки), а значение - тип. Подробнее см. в <структура>соответствующем разделе
	"folders" - массив с перечислением всех папок, начиная от самой верхней и кончая самой нижней, разработан с учетом возможности сложной структуры с большой степенью вложенности
	"page" - наконец, название страницы, которую необходимо загрузить, однако в ряде случаев может быть пустой, а еще может быть не последним элементом структуры
	"parameters" - массив параметров, которые были переданы с адресом страницы. Подробнее см. ниже

Язык сайта определяется для того, чтобы можно было осуществить переход на нужную языковую страницу. Например, при запросе {{ "http://site.com/ru/documents/about" }} или {{ "http://site.com/en/documents/about" }}.

(!) В данной версии роутера язык следует сразу же после имени сайта. Однако, вы можете написать свой роутер, в том числе для обработки ссылок вроде {{ "http://ru.site.com/documents/about" }} и {{ "http://en.site.com/documents/about" }}.

(!) Однако для административной части сайта язык назначается после раздела: {{ "http://site.com/administator/ru/" }} или {{ "http://site.com/administator/en/" }}.

Параметры ссылки - это все данные, которые были разобраны роутером после элементов структуры. Работа с параметрами ссылки очень важна. Например, по ним реализована загрузка, фильтрация и отображение <контент>материалов.

Подробнее о параметрах ссылки - ниже.

======================================
Принцип работы роутера (старая версия)
======================================

Пример разбора адресной строки {{ http://site.com/ru/documents/about }}:

	1. http://site.com
	2. ru
	3. documents
	4. about

1. Адрес сайта.

2. Язык сайта.

Определяется исходя из значения <переменные>ROOT_LANG и если совпадает с ним, то происходит редирект на тот же адрес, но без языкового значения, например на {{ http://site.com/documents/about }}

Если же язык не совпадает с <переменные>ROOT_LANG, то переключаются <параметры шаблона>языковые параметры шаблона. Т.к. роутер работает еще до загрузки всех других компонентов, это позволяет подгружать нужные <языки>языковые файлы

3. Папка (в данном случае) или файл.

Определяется просто:

	если есть следующий компонент
	если есть папка шаблона с таким же названием
	если есть папка в текущем шаблоне с таким же названием

4. Файл.

Определяется просто - последний компонент всегда файл.

Если в адресной строке есть другие значения, они просто не будут учитываться. Например, строка {{ http://site.com/ru/documents/about/current?page=15&sort="id" }} будет все равно разобрана как {{ http://site.com/documents/about }}.

=====================================
Принцип работы роутера (новая версия)
=====================================

Пример разбора адресной строки {{ http://site.com/ru/documents/about }}.

Разбор ведется поэтапно. Разбирается не вся строка целиком, а только значение <переменные>$_SERVER["REQUEST_URI"]: {{ /ru/documents/about }}

1. Если значение присутствует в массиве определенных для сайта языков, то это - язык сайта.

2. Если значение присутствует в списке шаблонов, то это - <шаблон>шаблон сайта. Список формируется при инициализации роутера из названий папок, кроме системных - "base", "default", "restore" и заданных константами <переменные>NAME_PERSONAL и <переменные>NAME_PRIVATE).

3. Далее названия проверяются по <структура>структуре:

	если название совпадает с папкой в структуре, то это - папка
	если название совпадает с файлом в структуре, то это - файл
	если такого названия нет, то считается, что это - ошибочная папка или страница

4. Все, что следует далее - это параметры ссылки.

(!) Обратите внимание, это - параметры адреса запроса. Не следует путать их с параметрами шаблона или настройками роутера. Подробнее о них сказано ниже.

Например, нет никакой разницы между {{ http://site.com/ru/documents/about/page/all }} и {{ http://site.com/ru/documents/about?page=all }}.

	если параметры не разрешены, то каждое следующее название, кроме последнего - это папки, последнее название - это файл
	если в структуре эта папка или файл являются статьями, первый параметр - это название статьи или {{ page=all }} если значение параметра "all"
	если параметров нечетное количество, то первый параметр - это значение параметра "default"

5. Если файла нет, то последняя папка становится файлом

(!) Стоит учесть, что если страница лежит во внутренней директории шаблона /html/inner/, она будет прочтена и открыта, даже несмотря на отсутствие ее в структуре сайта. Это может быть очень удобно, например, для обработки регистрации и авторизации - когда можно задать страницы [register.php] и [login.php] и не включать их в структуру. Но в общем случае это не правильно и вполне возможно, будет исправлено в дальнейшем.

================
Параметры ссылки
================

Не со всеми ссылками можно передавать параметры. Для таких ссылок в структуре должен быть указан тип "params". Для типа "article" также разрешена передача параметров.

Параметры задаются в ссылке в виде: {{ http://site.com/folder/page/param1_name/param1_value/param2_name/param2_value/ }}

Однако можно передать параметры и в виде обычного get-запроса {{  http://site.com/folder/page?param1_name=param1_value&param2_name=param2_value }}. Причем в таком виде параметры считываются в любом случае, даже если нужный тип в структуре не задан.

По-сути, вы можете передавать по ссылке любые параметры, важно только соблюдать несколько правил:

	- вид параметров должен быть один, в такой ссылке {{ http://site.com/folder/page/param1_name/param1_value?param2_name=param2_value }} будут прочтены только "/param1_name/param1_value/"
	- параметрами считается все, что идет после элементов структуры, т.е. после того, как были определены имена папок и файлов
	- после параметра обязательно должно быть указано его значение

(!) Исключением являются <контент>материалы. Так, если в структуре папке или файлу был задан тип "article", первое значение, идущее в параметрах ссылки, считается материалом и для него автоматически создается параметр "article".

(!) Второе исключение - слово "all" в первом параметре. Оно автоматически считается значением параметра "page".

Если же был задан единственный параметр или число параметров нечетное, то первый параметр считается значением параметра "default".

Так что если вы будете передавать параметры, следите чтобы в значении всегда что-то было. Для пустых значений можно использовать ноль, символ точки или другое.

Таким образом, есть три зарезервированных системой параметра:

	"article" - параметр, отвечающий за название <контент>материала (новости, статьи)
	"page" - параметр, отвечающий за вывод определенных материалов или части одного материала (страницы)
	"default" - параметр, специально созданный для тех случаев, когда по ссылке требуется передать только один параметр

Для наглядности разберем несколько ссылок.

У нас есть следующая структура сайта:

	"documents"
		"about"
		"license"
	"catalog:article"
	"contacts"

Здесь "documents" - это папка, "about" и "license" - это файлы, "catalog" - это тоже файл, но с типом "article", т.е. это файл, куда будут загружаться материалы из соответствующего раздела, и "contacts" - это тоже файл.

Ссылка {{ http://site.com/documents/about }}

	"folders" - массив с элементом [documents]
	"page" = "about"
	"parameters" - пустой объект

Ссылка {{ http://site.com/documents }}

	"folders" - пустой массив
	"page" = "documents"
	"parameters" - пустой объект

Ссылка {{ http://site.com/catalog/all }}

	"folders" - пустой массив
	"page" = "catalog"
	"parameters" - объект со следующими параметрами:
		"article" - пустой параметр
		"page" = "all"

Ссылка {{ http://site.com/catalog?page=all }}

	"folders" - пустой массив
	"page" = "catalog"
	"parameters" - объект со следующими параметрами:
		"article" - пустой параметр
		"page" = "all"

Ссылка {{ http://site.com/catalog/123 }}

	"folders" - пустой массив
	"page" = "catalog"
	"parameters" - объект со следующими параметрами:
		"article" = "123"

Ссылка {{ http://site.com/contacts }}

	"folders" - пустой массив
	"page" = "contacts"
	"parameters" - пустой объект

Неправильная ссылка {{ http://site.com/catalog/page/all }}

	"folders" - пустой массив
	"page" = "catalog"
	"parameters" - объект со следующими параметрами:
		"article" = "page"
		"default" = "all"

(!) Ссылка неправильная, т.к. для раздела "catalog" указан тип "article", соответственно первым он ожидает принять значение параметра "article". А при значении "all" название параметра не передается.

Неправильная ссылка {{ http://site.com/catalog?article=123 }}

	"folders" - пустой массив
	"page" = "catalog"
	"parameters" - объект со следующими параметрами:
		"article" = ""

(!) Ссылка неправильная, т.к. для раздела "catalog" указан тип "article", соответственно первым он ожидает принять значение параметра "article". При этом разбор параметров уже назначен на вид "/.../.../", и параметры другого вида приниматься не будут.

Пример смещения параметров в ссылке {{ http://site.com/catalog/123/page/all/lang/ru/ }}

	"folders" - пустой массив
	"page" = "catalog"
	"parameters" - объект со следующими параметрами:
		"article" = "123"
		"page" = "all"
		"lang" = "ru"

Пример смещения параметров в ссылке {{ http://site.com/catalog/123/page/all/lang/ru/no/ }}

	"folders" - пустой массив
	"page" = "catalog"
	"parameters" - объект со следующими параметрами:
		"article" = "123"
		"default" = "page"
		"all" = "lang"
		"ru" = "no"

=====================
Инициализация роутера
=====================

	$path = (object) array(
		"split" => $_SERVER["REQUEST_URI"]
		"templates" => dirconnect(PATH_TEMPLATES, ["base", "default", "restore"]),
		"structure" => array(),
		"counter" => "",
		"current" => (object) array(
			"item" => "",
			"structure" => array(),
			"split" => array(),
			"folders" => array(),
			"params" => "",
		),
		"lang" => "",
		"template" => "",
		"types" => array(),
		"folders" => array(),
		"page" => "",
		"parameters" => array()
	);

==================
Описание структуры
==================

	"split" - адрес ссылки, целый или разбитый по частям
	"templates" - список названий всех имеющихся шаблонов, кроме нескольких запрещенных для перехода
	"structure" - фрагмент структуры сайта
	"counter" - счетчик для внутренних расчетов
	"current" - объект текущих данных, используется для обработки адреса ссылки
		
		"item" - текущий элемент адреса ссылки
		"structure" - фрагмент структуры сайта для поиска в нем папки или файла
		"split" - разбивка составного имени папки из структуры
		"folders" - список папок из составного имени структуры
		"params" - опция разрешения и/или запрещения параметров
		
	"lang" - язык, найденный в ссылке (или пустое значение)
	"template" - шаблон, найденный в ссылке (или пустое значение)
	"types" - массив типов из структуры, назначенных для каждой папки и страницы текущего пути
	"folders" - массив папок
	"page" - название текущей страницы, пустое значение если, например, страница индексная
	"parameters" - массив параметров ссылки, пустой массив если параметров нет
